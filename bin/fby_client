#!/usr/bin/env python
import sys
import os
import os.path
from serial import SerialException
import datetime
import time
import requests
from traceback import format_exception

SAMPLE_TIME = 10 * 60
EXCEPTION_SLEEP_TIME = 10 * 60
SLEEP_TIME  = 0.50

ROOT = os.path.abspath( os.path.join( os.path.dirname( __file__ ) , "../" ))
sys.path.insert(0 , os.path.join(ROOT , "lib"))
config_file = os.path.join( ROOT , "etc/config.json")
var_path = os.path.join(ROOT , "var")

import dist

from friskby_client import FriskbyClient
from sampler import Sampler
from device_config import DeviceConfig
from git_module import GitModule

if os.getenv("FRISKBY_TEST"):
    try:
        from sds011 import SDS011
    except SerialException:
        from mock_sds011 import SDS011
else:
    from sds011 import SDS011


def install(config):
    git_module = GitModule( url = config.getRepoURL() )
    git_module.checkout( config.getGitRef( ) )
    git_module.runTests( "tests/run_tests" )
    git_module.install( ROOT , files = dist.files , directories = dist.directories )
    config.save( filename = config_file )


def restart(config):
    install(config)
    os.execl( __file__ , __file__)

    raise Exception("Fatal error: os.execl() returned - trying to rollback")


def network_block():
    url = "http://www.google.com"
    timeout = 120
    start = datetime.datetime.now()
    while True:
        dt = datetime.datetime.now() - start
        if dt.total_seconds() > timeout:
            sys.exit("No network contact established - giving up")

        try:
            response = requests.get( url )
            if response.status_code == 200:
                break
        except Exception:
            time.sleep( 2 )



def rollback(config):
    install(config)

def main( argv ):
    network_block( )
    config = DeviceConfig( config_file )
    config.logMessage("Starting up")
    config.postGitVersion( )
    
    device_id = config.getDeviceID( )
    client_pm10 = FriskbyClient(config , "%s_PM10" % device_id, var_path)
    client_pm25 = FriskbyClient(config , "%s_PM25" % device_id, var_path)
    sampler = Sampler( SDS011(True) , SAMPLE_TIME , sleep_time = SLEEP_TIME )

    while True:
        try:
            data = sampler.collect( )
    
            client_pm10.post( data[0].mean() )
            client_pm25.post( data[1].mean() )

            new_config = config.downloadNew( )
            if new_config != config:
                try:
                    config.logMessage("Restarting - new git version:%s" % new_config.getGitRef())
                    restart( new_config )
                except Exception as exc:
                    config.logMessage("Restart failed - trying rollback")
                    rollback( config )
                    config.logMessage("Rollback complete")
        except KeyboardInterrupt as e:
            # KeyboardInterrupt - i.e. Ctrl-C is special cased to 
            # make sure we can interrupt a running client manually.
            raise
        except Exception as a:
            exc_type, exc_value, exc_tb = sys.exc_info()
            tb_list = format_exception( exc_type , exc_value , exc_tb)
            config.logMessage("Exception caught" , long_msg = "".join( tb_list ))
            time.sleep( EXCEPTION_SLEEP_TIME )

            

if __name__ == "__main__":
    main( sys.argv )
