#!/usr/bin/env python
import sys
import os
from serial import SerialException
from datetime import datetime as dt
import time
import requests
from traceback import format_exception
import json

ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), "../"))
sys.path.insert(0, os.path.join(ROOT, "lib"))
CONFIG_FILE = os.path.join(ROOT, "etc/config.json")
VAR_PATH = os.path.join(ROOT, "var")

import dist
from fby_submitter import FriskbySubmitter
from friskby_dao import FriskbyDao
from sampler import Sampler
from device_config import DeviceConfig
from git_module import GitModule
from os_release import sys_info
if os.getenv("FRISKBY_TEST"):
    try:
        from sds011 import SDS011
    except SerialException:
        from mock_sds011 import SDS011
else:
    from sds011 import SDS011

def get_sys_info():
    info = ''
    try:
        info = sys_info()
        if info:
            info = json.dumps(info, indent=4, sort_keys=True)
    except Exception as e:
        info = 'Error getting sys_info: "%s".' % e
    return info

class FbyRunner(object):

    def __init__(self, var_path=None):
        self._sample_time = 10 * 60
        self._sleep_time = 0.5
        self._exception_count = 0 #  #exceptions since last success
        self._accuracy = 4 # round observation to fourth digit
        self._config = None
        if not var_path:
            var_path = '/usr/local/friskby/var'
        self._sql_path = os.path.join(var_path, 'friskby.sql')
        self._dao = FriskbyDao(self._sql_path)
        self._submitter = FriskbySubmitter(self._dao)

    def get_dao(self):
        return self._dao

    def get_submitter(self):
        return self._submitter

    @staticmethod
    def install(config):
        git_module = GitModule(url=config.getRepoURL())
        git_module.checkout(config.getGitRef())
        git_module.runTests("tests/run_tests")
        git_module.install(ROOT, files=dist.files, directories=dist.directories)
        config.save(filename=CONFIG_FILE)


    @classmethod
    def rollback(cls, config):
        cls.install(config)


    @classmethod
    def restart(cls, config):
        cls.install(config)
        os.execl(__file__, __file__)

        raise Exception("Fatal error: os.execl() returned - trying to rollback")

    @classmethod
    def updateClient(cls, config):
        new_config = config.downloadNew()
        if config.updateRequired(new_config):
            try:
                config.logMessage("Restarting client - new version:%s" % new_config.getGitRef())
                cls.restart(new_config)
            except:
                exc_type, exc_value, exc_tb = sys.exc_info()
                tb_list = format_exception(exc_type, exc_value, exc_tb)
                config.logMessage("Restart failed - trying rollback", long_msg="".join(tb_list))
                cls.rollback(config)
                config.logMessage("Rollback complete")


    def _handle_post_exception(self, err, exc_info):
        self._exception_count += 1
        if self._exception_count > 5:
            return
        err_msg = '(unknown error for %s)' % str(type(err))
        try:
            err_msg = str(err)
        except Exception:
            pass
        exc_type, exc_value, exc_tb = exc_info
        tb_list = format_exception(exc_type, exc_value, exc_tb)
        log_payload = 'Exception caught: "%s".' % (err_msg)
        traceback = "".join(tb_list)
        try:
            self._config.logMessage(log_payload, long_msg=traceback)
        except:
            sys.stderr.write('Error submitting log message!')

    def run(self):

        self._config = DeviceConfig(CONFIG_FILE)
        long_msg = get_sys_info()
        self._config.logMessage("Starting up", long_msg=long_msg)
        self._config.postGitVersion()

        self._submitter.set_config(self._config)
        sampler = Sampler(SDS011(True), self._dao,
                          self._sample_time, sleep_time=self._sleep_time,
                          accuracy=self._accuracy)

        while True:
            if self._exception_count >= 5:
                print('Warning: exception count exceeded')
                sys.stdout.flush()
                sys.exit('Exception count exceeded.  Giving up.')
            try:
                print('Collecting ...')
                sys.stdout.flush()
                sampler.collect()

                self._submitter.post()
                print('Updating ...')
                sys.stdout.flush()
                self.updateClient(self._config)
            except Exception as err:
                self._handle_post_exception(err, sys.exc_info())
            else:
                # try/except/else: if nothing has been raised we successfully posted
                self._exception_count = 0


if __name__ == "__main__":
    fby = FbyRunner()
    fby.run()
